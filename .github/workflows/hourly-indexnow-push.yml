name: IndexNow Rotating Push

on:
  # Every 6 hours — rotates through 10 URLs at a time
  schedule:
    - cron: '15 */6 * * *'
  # On deploy — sends ALL URLs (content actually changed)
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  indexnow-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Submit URLs to IndexNow
        run: |
          KEY="3a879a2ef23c46a39d3b0926392655e1"
          
          # === MASTER URL LIST (74 pages) ===
          # Ordered by priority — highest-value pages first
          ALL_URLS=(
            # Group 0: Money pages
            "https://justlegalsolutions.org/"
            "https://justlegalsolutions.org/tulsa-process-server"
            "https://justlegalsolutions.org/services"
            "https://justlegalsolutions.org/pricing"
            "https://justlegalsolutions.org/contact"
            "https://justlegalsolutions.org/law-firm-services"
            "https://justlegalsolutions.org/weekend-emergency"
            "https://justlegalsolutions.org/urgent-process-server"
            "https://justlegalsolutions.org/about"
            "https://justlegalsolutions.org/reviews"
            
            # Group 1: More core pages
            "https://justlegalsolutions.org/faq"
            "https://justlegalsolutions.org/why-choose-us"
            "https://justlegalsolutions.org/affidavit-of-service"
            "https://justlegalsolutions.org/courier-services-tulsa"
            "https://justlegalsolutions.org/virtual-assistant-services"
            "https://justlegalsolutions.org/payments"
            "https://justlegalsolutions.org/leave-review"
            "https://justlegalsolutions.org/service-areas/broken-arrow"
            "https://justlegalsolutions.org/service-areas/owasso"
            "https://justlegalsolutions.org/service-areas/jenks"
            
            # Group 2: High-population cities
            "https://justlegalsolutions.org/service-areas/bixby"
            "https://justlegalsolutions.org/service-areas/sand-springs"
            "https://justlegalsolutions.org/service-areas/sapulpa"
            "https://justlegalsolutions.org/service-areas/claremore"
            "https://justlegalsolutions.org/service-areas/bartlesville"
            "https://justlegalsolutions.org/service-areas/catoosa"
            "https://justlegalsolutions.org/service-areas/collinsville"
            "https://justlegalsolutions.org/service-areas/coweta"
            "https://justlegalsolutions.org/service-areas/glenpool"
            "https://justlegalsolutions.org/service-areas/skiatook"
            
            # Group 3: More cities + start counties
            "https://justlegalsolutions.org/service-areas/wagoner"
            "https://justlegalsolutions.org/service-areas/bristow"
            "https://justlegalsolutions.org/service-areas/kellyville"
            "https://justlegalsolutions.org/service-areas/pawhuska"
            "https://justlegalsolutions.org/service-areas/pryor"
            "https://justlegalsolutions.org/counties/tulsa-county"
            "https://justlegalsolutions.org/counties/rogers-county"
            "https://justlegalsolutions.org/counties/wagoner-county"
            "https://justlegalsolutions.org/counties/washington-county"
            "https://justlegalsolutions.org/counties/creek-county"
            
            # Group 4: Counties + top guides
            "https://justlegalsolutions.org/counties/osage-county"
            "https://justlegalsolutions.org/counties/okmulgee-county"
            "https://justlegalsolutions.org/counties/mayes-county"
            "https://justlegalsolutions.org/counties/nowata-county"
            "https://justlegalsolutions.org/ultimate-guide-process-serving-oklahoma"
            "https://justlegalsolutions.org/process-server-tulsa-guide"
            "https://justlegalsolutions.org/oklahoma-process-server-laws"
            "https://justlegalsolutions.org/oklahoma-process-server-pricing"
            "https://justlegalsolutions.org/oklahoma-process-server-faq-2026"
            "https://justlegalsolutions.org/oklahoma-process-server-best-practices-checklist-2026"
            
            # Group 5: More guides
            "https://justlegalsolutions.org/oklahoma-process-server-pricing-2026"
            "https://justlegalsolutions.org/oklahoma-process-server-technology"
            "https://justlegalsolutions.org/oklahoma-process-serving-costs-comparison"
            "https://justlegalsolutions.org/oklahoma-case-law-service-process"
            "https://justlegalsolutions.org/oklahoma-electronic-service-guide"
            "https://justlegalsolutions.org/oklahoma-legal-service-areas"
            "https://justlegalsolutions.org/oklahoma-process-server-authority"
            "https://justlegalsolutions.org/oklahoma-vs-texas-process-server"
            "https://justlegalsolutions.org/family-law-service-guide-tulsa"
            "https://justlegalsolutions.org/high-profile-service-protocols-tulsa"
            
            # Group 6: Niche guides + SEO pages
            "https://justlegalsolutions.org/ai-skip-tracing-guide-oklahoma"
            "https://justlegalsolutions.org/process-serving-mistakes-guide"
            "https://justlegalsolutions.org/serving-legal-papers-on-tribal-land"
            "https://justlegalsolutions.org/resources"
            "https://justlegalsolutions.org/seo/eviction-notice-process-server"
            "https://justlegalsolutions.org/seo/legal-posting-process-server"
            "https://justlegalsolutions.org/seo/process-server-nowata"
            "https://justlegalsolutions.org/seo/process-server-vinita"
          )
          
          TOTAL=${#ALL_URLS[@]}
          BATCH_SIZE=10
          NUM_GROUPS=$(( (TOTAL + BATCH_SIZE - 1) / BATCH_SIZE ))
          
          # On deploy: send ALL URLs (content actually changed)
          # On schedule: rotate through groups of 10
          EVENT="${{ github.event_name }}"
          
          if [ "$EVENT" = "push" ]; then
            echo "=== DEPLOY: Submitting all $TOTAL URLs ==="
            BATCH=("${ALL_URLS[@]}")
          else
            # Rotation: use day-of-year + time slot to pick which group
            DAY=$(date -u +%j)
            HOUR=$(date -u +%H)
            TIME_SLOT=$(( HOUR / 6 ))
            GROUP=$(( (DAY * 4 + TIME_SLOT) % NUM_GROUPS ))
            START=$(( GROUP * BATCH_SIZE ))
            BATCH=("${ALL_URLS[@]:$START:$BATCH_SIZE}")
            echo "=== SCHEDULED: Group $GROUP of $((NUM_GROUPS - 1)) — ${#BATCH[@]} URLs (starting at index $START) ==="
            echo "URLs in this batch:"
            for u in "${BATCH[@]}"; do echo "  $u"; done
          fi
          
          # Build JSON array
          URL_JSON=""
          for url in "${BATCH[@]}"; do
            [ -n "$URL_JSON" ] && URL_JSON="$URL_JSON,"
            URL_JSON="$URL_JSON\"$url\""
          done
          
          # Submit to IndexNow
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://api.indexnow.org/indexnow" \
            -H "Content-Type: application/json" \
            -d "{\"host\":\"justlegalsolutions.org\",\"key\":\"$KEY\",\"keyLocation\":\"https://justlegalsolutions.org/$KEY.txt\",\"urlList\":[$URL_JSON]}")
          
          echo "IndexNow response: HTTP $HTTP_CODE (${#BATCH[@]} URLs submitted)"
          
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "WARNING: IndexNow returned error $HTTP_CODE"
          fi
          
          # Sitemap pings (lightweight, always do these)
          curl -s "https://www.google.com/ping?sitemap=https://justlegalsolutions.org/sitemap.xml" > /dev/null || true
          curl -s "https://www.bing.com/ping?sitemap=https://justlegalsolutions.org/sitemap.xml" > /dev/null || true
          
          echo "Done — sitemap pings sent to Google and Bing"
